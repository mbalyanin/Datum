{% extends 'registration/base.html' %}
{% load static %}

{% block content %}
<div class="reg-container" style="width: 900px; min-height: 530px; flex-direction: row; left: 20%;">

    <div class="just-box" style="min-width: 300px; min-height: 600px; flex: 1; display: flex; flex-direction: column; background: #1a1a1a;">
        <!-- Основная область -->
        <!-- Список симпатий (изначально виден) -->
        <div id="matches-list" style="flex: 1; overflow-y: auto; padding: 20px;">
            <h2 style="color: white; margin-bottom: 20px;">Ваши симпатии</h2>

            {% for match in matches %}
            <div class="match-card" data-user-id="{{ match.id }}" onclick="openChat({{ match.id }}, '{{ match.name }}')"
                 style="min-width: 260px; display: flex; align-items: center; padding: 15px; margin-bottom: 15px; background: #222; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                {% if match.avatar %}
                    <img src="{{ match.avatar.url }}" alt="{{ match.name }}"
                         style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid {% if match.unread %}#ff4d4d{% else %}#444{% endif %};">
                {% else %}
                    <img src="{% static 'user/img/default_profile_pic.jpg' %}"
                         style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid {% if match.unread %}#ff4d4d{% else %}#444{% endif %};">
                {% endif %}
                <div>
                    <h2 style="margin: 0; color: white; font-size: 18px;">{{ match.name }}, {{ match.age }}</h2>
                    <p style="margin: 5px 0 0; color: #aaa; font-size: 14px;">
                        {% if match.last_message %}
                            {% if match.last_message.sender.id == request.user.id %}
                                Вы: {{ match.last_message.content|truncatechars:30 }}
                            {% else %}
                                {{ match.last_message.content|truncatechars:30 }}
                            {% endif %}
                        {% else %}
                            Нет сообщений
                        {% endif %}
                    </p>
                </div>
            </div>
            {% empty %}
            <p style="color: #777; text-align: center; padding: 40px 0;">У вас пока нет взаимных симпатий</p>
            {% endfor %}
        </div>
    </div>

    <!--  В отдельной фигне картинка и чат сам -->
    <div class="just-box" style="min-width: 600px; min-height: 600px;">
        <!--  НЕ Боковая панель с иконками (изначально скрыта) -->
        <div id="icons-sidebar" style="width: 0; overflow: hidden; transition: width 0.3s; display: flex; flex-direction: column; align-items: center;">
            <div id="chat-icon-container"></div>
        </div>

        <!-- Заголовок чата -->
        <div id="chat-header" style="padding: 15px; background: #222; border-bottom: 1px solid #444; display: flex; align-items: center;">
                <h2 id="chat-with-user" style="margin: 0; color: white; font-size: 18px;">Выберите чат</h2>
        </div>
        <!-- Окно чата (изначально скрыто) -->
        <div id="chat-container" style="max-height: 450px; visibility: hidden; flex: 1; flex-direction: column; background: #1a1a1a;">

            <!-- История сообщений -->
            <div id="messages-container" style="visibility: hidden; width: 550px; flex: 1; padding: 20px; overflow-y: auto;"></div>

            <!-- Поле ввода -->
            <div style="padding: 15px; background: #222; border-top: 1px solid #444;">
                <input type="text" id="message-input" placeholder="Напишите сообщение..."
                       style="visibility: hidden; width: 100%; padding: 12px; background: #000; color: white;">
            </div>
        </div>
    </div>
</div>

<script>
    const currentUserId = {{ request.user.id }};
    let currentChatId = null;
    let currentActiveIcon = null;
    let chatSocket = null;
    const messagesContainer = document.getElementById('messages-container');

    // Инициализация WebSocket соединения
    function initWebSocket() {
        const wsScheme = window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsPath = wsScheme + window.location.host + "/ws/chat/";

        chatSocket = new WebSocket(wsPath);

        chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'chat.message') {
            const msg = data.message;
            const isCurrentChat = currentChatId &&
                                (currentChatId == msg.sender_id ||
                                 currentChatId == msg.receiver_id);

            if (isCurrentChat) {
                const formattedMsg = {
                    ...msg,  // Копируем все поля сообщения
                    timestamp: formatTimestamp(msg.timestamp)  // Применяем форматирование
                };
                appendMessage(formattedMsg, msg.sender_id !== currentUserId);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Обновляем список чатов в любом случае
            updateLastMessageInList(msg.sender_id, msg.content);
        }
    };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
            setTimeout(initWebSocket, 2000);
        };
    }

    // Форматирование времени для отображения
   function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Функция для обновления последнего сообщения в списке чатов
    function updateLastMessageInList(userId, content) {
        const matchIndex = matchesData.findIndex(match => match.id === userId);
        if (matchIndex !== -1) {
            matchesData[matchIndex].last_message = {
                sender_id: userId,
                content: content
            };
        }
    }

    function openChat(userId, userName) {
        currentChatId = userId;
        document.getElementById('chat-with-user').textContent = `Чат с ${userName}`;

        // Показываем элементы чата
        document.getElementById('message-input').style.visibility = 'visible';
        document.getElementById('messages-container').style.visibility = 'visible';
        document.getElementById('chat-container').style.display = 'flex';
        document.getElementById('chat-container').style.visibility = 'visible';

        // Загружаем историю сообщений
        loadChatHistory(userId);

        // Обновляем иконку в боковой панели
        updateChatIcon(userId, userName);

        // Помечаем сообщения как прочитанные
        markAsRead(userId);
    }

    // Пометить сообщения как прочитанные
    function markAsRead(userId) {
        const matchIndex = matchesData.findIndex(match => match.id === userId);
        if (matchIndex !== -1) {
            matchesData[matchIndex].unread = false;

            // Обновляем border аватарки
            const matchCard = document.querySelector(`.match-card[data-user-id="${userId}"]`);
            if (matchCard) {
                const avatarImg = matchCard.querySelector('img');
                if (avatarImg) {
                    avatarImg.style.borderColor = '#444';
                }
            }
        }
    }

    // Обработчик отправки сообщения
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value.trim() && currentChatId) {
            const message = this.value.trim();
            const now = new Date();
            const timestamp = now.toISOString();

            // Создаем временное сообщение для мгновенного отображения
            appendMessage({
                content: message,
                timestamp: formatTimestamp(timestamp),
                sender: currentUserId
            }, false);

            this.value = '';

            // Отправляем сообщение на сервер
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: 'chat_message',
                    receiver_id: currentChatId,
                    content: message,
                    timestamp: timestamp
                }));
            }

            // Прокручиваем чат вниз
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    });

    function updateChatIcon(userId, userName) {
        const selectedMatch = matchesData.find(match => match.id === userId);
        if (!selectedMatch) return;

        const avatarUrl = selectedMatch.avatar ? selectedMatch.avatar : defaultAvatarUrl;
        const chatIconContainer = document.getElementById('chat-icon-container');

        chatIconContainer.innerHTML = `
            <div class="chat-icon" data-user-id="${userId}" style="width: 50px; height: 50px; margin: 15px 0; position: relative; cursor: pointer;">
                <img src="${avatarUrl}" alt="${userName}"
                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #fff;">
                ${selectedMatch.unread ? `
                <div style="position: absolute; top: -5px; right: -5px; width: 12px; height: 12px; background: #ff4d4d; border-radius: 50%; border: 2px solid #1a1a1a;"></div>` : ''}
            </div>
        `;
    }

    function loadChatHistory(userId) {
        fetch(`/api/messages/${userId}/`)
            .then(response => response.json())
            .then(data => {
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';

                data.messages.forEach(msg => {
                    appendMessage(msg, msg.sender === userId);
                });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            })
            .catch(error => console.error('Error loading chat history:', error));
    }

    function appendMessage(msg, isReceived) {
        const messagesContainer = document.getElementById('messages-container');
        const messageDiv = document.createElement('div');

        messageDiv.style.marginBottom = '15px';
        messageDiv.style.maxWidth = '80%';
        messageDiv.style.alignSelf = isReceived ? 'flex-start' : 'flex-end';
        messageDiv.style.textAlign = isReceived ? 'left' : 'right';

        // Добавляем класс для анимации
        if (msg.is_realtime) {
            messageDiv.classList.add('message-realtime');
        }

        messageDiv.innerHTML = `
            <div style="padding: 10px 15px; background: ${isReceived ? '#333' : '#444'}; border-radius: 18px; display: inline-block;">
                <div style="color: white;">${msg.content}</div>
            </div>
            <div style="font-size: 12px; color: #777; margin: 5px ${isReceived ? '0 0 15px' : '15px 0 0'};">
                ${msg.timestamp}
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Вспомогательная функция для получения CSRF токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Инициализация WebSocket при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        initWebSocket();
    });
</script>
<script>
    const defaultAvatarUrl = "{% static 'user/img/default_profile_pic.jpg' %}";
    const matchesData = [
        {% for match in matches %}
        {
            id: {{ match.id }},
            name: "{{ match.name|escapejs }}",
            age: {{ match.age }},
            avatar: {% if match.avatar %}"{{ match.avatar.url }}"{% else %}null{% endif %},
            unread: {{ match.unread|yesno:"true,false" }},
            last_message: {% if match.last_message %}{
                sender_id: {{ match.last_message.sender.id }},
                content: "{{ match.last_message.content|escapejs }}"
            }{% else %}null{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
</script>
{% endblock %}